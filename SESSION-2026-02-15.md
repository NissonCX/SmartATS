# SmartATS å¼€å‘ä¼šè¯æ€»ç»“ - 2026-02-15

> **ä¼šè¯ç›®æ ‡**ï¼šå®ç°çœŸå®çš„æ³¨å†Œ/ç™»å½•åŠŸèƒ½ + å®Œå–„é”™è¯¯ç ä½“ç³»
> **ä¼šè¯ç»“æœ**ï¼šâœ… æˆåŠŸï¼ˆä»£ç å·²å®Œæˆï¼Œå¾…é…ç½® Spring Security åæµ‹è¯•ï¼‰

---

## ğŸ“‹ æœ¬æ¬¡ä¼šè¯æ ¸å¿ƒæˆæœ

### 1. âœ… å®Œæˆæ•°æ®åº“è¡¨è®¾è®¡æ–‡æ¡£

**æ–°å»ºæ–‡ä»¶**ï¼š
```
src/main/resources/sql/init.sql
```

**å†…å®¹**ï¼š
- åˆ›å»º `smartats` æ•°æ®åº“
- åˆ›å»º `users` è¡¨ï¼ˆåŒ…å«å®Œæ•´å­—æ®µã€ç´¢å¼•ã€æ³¨é‡Šï¼‰
- æ’å…¥æµ‹è¯•æ•°æ®ï¼ˆç®¡ç†å‘˜å’Œ HR è´¦å·ï¼‰

**è®¾è®¡äº®ç‚¹**ï¼š
- ä½¿ç”¨ `BIGINT` ä¸»é”®ï¼ˆæ”¯æŒæµ·é‡æ•°æ®ï¼‰
- `ENUM` ç±»å‹å­˜å‚¨è§’è‰²ï¼ˆæ•°æ®ä¸€è‡´æ€§ï¼‰
- BCrypt åŠ å¯†å­˜å‚¨å¯†ç ï¼ˆå®‰å…¨æ€§ï¼‰
- å®Œæ•´çš„ç´¢å¼•è®¾è®¡ï¼ˆæŸ¥è¯¢ä¼˜åŒ–ï¼‰

---

### 2. âœ… å®ç° UserService çœŸå®æ•°æ®åº“äº¤äº’

**æ–‡ä»¶ä¿®æ”¹**ï¼š
```
src/main/java/com/smartats/module/auth/service/UserService.java
```

**å®ç°åŠŸèƒ½**ï¼š

#### 2.1 æ³¨å†Œæ–¹æ³•ï¼ˆregisterï¼‰

**ä¸šåŠ¡æµç¨‹**ï¼š
```
1. æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨ï¼ˆLambdaQueryWrapperï¼‰
   â””â”€ å­˜åœ¨ â†’ æŠ›å‡º USERNAME_ALREADY_EXISTS å¼‚å¸¸

2. æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨ï¼ˆLambdaQueryWrapperï¼‰
   â””â”€ å­˜åœ¨ â†’ æŠ›å‡º EMAIL_ALREADY_EXISTS å¼‚å¸¸

3. å¯†ç åŠ å¯†ï¼ˆBCryptPasswordEncoderï¼‰
   â””â”€ åŸå§‹å¯†ç  â†’ $2a$10$...

4. åˆ›å»º User å¯¹è±¡å¹¶è®¾ç½®é»˜è®¤å€¼
   - role: HRï¼ˆé»˜è®¤ï¼‰
   - dailyAiQuota: 100
   - status: 1ï¼ˆå¯ç”¨ï¼‰

5. ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆuserMapper.insertï¼‰
   â””â”€ å¤±è´¥ â†’ æŠ›å‡º INTERNAL_ERROR å¼‚å¸¸

6. è®°å½•æˆåŠŸæ—¥å¿—
```

**å…³é”®ä»£ç **ï¼š
```java
Long usernameCount = userMapper.selectCount(
    new LambdaQueryWrapper<User>()
        .eq(User::getUsername, request.getUsername())
);
if (usernameCount > 0) {
    throw new BusinessException(ResultCode.USERNAME_ALREADY_EXISTS);
}

String encodedPassword = passwordEncoder.encode(request.getPassword());
user.setPassword(encodedPassword);

userMapper.insert(user);
```

**è®¾è®¡äº®ç‚¹**ï¼š
- ä½¿ç”¨ `LambdaQueryWrapper`ï¼ˆç±»å‹å®‰å…¨ï¼Œé‡æ„å‹å¥½ï¼‰
- ä½¿ç”¨ `@Transactional`ï¼ˆä¿è¯äº‹åŠ¡ä¸€è‡´æ€§ï¼‰
- ç»Ÿä¸€å¼‚å¸¸å¤„ç†ï¼ˆBusinessExceptionï¼‰
- è¯¦ç»†æ—¥å¿—è®°å½•ï¼ˆinfo/warn/error/debug åˆ†çº§ï¼‰

#### 2.2 ç™»å½•æ–¹æ³•ï¼ˆloginï¼‰

**ä¸šåŠ¡æµç¨‹**ï¼š
```
1. æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·
   â””â”€ ä¸å­˜åœ¨ â†’ æŠ›å‡º INVALID_CREDENTIALSï¼ˆç»Ÿä¸€é”™è¯¯æç¤ºï¼‰

2. éªŒè¯å¯†ç ï¼ˆBCryptPasswordEncoder.matchesï¼‰
   â””â”€ é”™è¯¯ â†’ æŠ›å‡º INVALID_CREDENTIALSï¼ˆç»Ÿä¸€é”™è¯¯æç¤ºï¼‰

3. æ£€æŸ¥è´¦å·çŠ¶æ€
   â””â”€ ç¦ç”¨ â†’ æŠ›å‡º ACCOUNT_DISABLED

4. ç”Ÿæˆ Tokenï¼ˆJWTï¼‰
   - accessTokenï¼ˆ2å°æ—¶ï¼‰
   - refreshTokenï¼ˆ7å¤©ï¼‰

5. æ„é€ å“åº”å¯¹è±¡ï¼ˆLoginResponseï¼‰
   - ä¸è¿”å›å¯†ç ï¼ˆæ•æ„Ÿä¿¡æ¯ï¼‰
   - åŒ…å«å®Œæ•´ç”¨æˆ·ä¿¡æ¯
```

**å…³é”®ä»£ç **ï¼š
```java
User user = userMapper.selectOne(
    new LambdaQueryWrapper<User>()
        .eq(User::getUsername, request.getUsername())
);

if (user == null) {
    throw new BusinessException(ResultCode.INVALID_CREDENTIALS, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
}

boolean passwordMatch = passwordEncoder.matches(request.getPassword(), user.getPassword());
if (!passwordMatch) {
    throw new BusinessException(ResultCode.INVALID_CREDENTIALS, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
}

String accessToken = jwtUtil.generateToken(user.getId(), user.getUsername(), user.getRole());
String refreshToken = jwtUtil.generateRefreshToken(user.getId(), user.getUsername());
```

**å®‰å…¨è®¾è®¡**ï¼š
- ç»Ÿä¸€é”™è¯¯æç¤ºï¼ˆé˜²æ­¢ç”¨æˆ·åæšä¸¾æ”»å‡»ï¼‰
- å¯†ç éªŒè¯å¤±è´¥ä¸æš´éœ²å…·ä½“åŸå› 
- çŠ¶æ€æ£€æŸ¥åœ¨å¯†ç éªŒè¯ä¹‹åï¼ˆé˜²æ­¢é€šè¿‡å“åº”æ—¶é—´åˆ¤æ–­ï¼‰

---

### 3. âœ… å®Œå–„é”™è¯¯ç ä½“ç³»ï¼ˆResultCodeï¼‰

**æ–‡ä»¶ä¿®æ”¹**ï¼š
```
src/main/java/com/smartats/common/result/ResultCode.java
```

**æ–°å¢é”™è¯¯ç **ï¼š
```java
// ========== è®¤è¯æ¨¡å—é”™è¯¯ 10xxx ==========
USERNAME_ALREADY_EXISTS(10003, "ç”¨æˆ·åå·²å­˜åœ¨"),
EMAIL_ALREADY_EXISTS(10004, "é‚®ç®±å·²è¢«æ³¨å†Œ"),
INVALID_CREDENTIALS(10006, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"),
ACCOUNT_DISABLED(10008, "è´¦å·å·²è¢«ç¦ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜"),
TOKEN_INVALID(10009, "Token æ— æ•ˆæˆ–å·²è¿‡æœŸ"),
TOKEN_REFRESH_FAILED(10010, "Token åˆ·æ–°å¤±è´¥"),
```

**è®¾è®¡åŸåˆ™**ï¼š
- è¯­ä¹‰åŒ–ï¼ˆé”™è¯¯ç åç§°æ¸…æ™°è¡¨è¾¾é”™è¯¯ç±»å‹ï¼‰
- å®‰å…¨æ€§ï¼ˆç»Ÿä¸€é”™è¯¯æç¤ºï¼Œé˜²æ­¢ä¿¡æ¯æ³„éœ²ï¼‰
- å¯æ‰©å±•ï¼ˆä¸ºæœªæ¥åŠŸèƒ½é¢„ç•™é”™è¯¯ç ï¼‰

---

### 4. âœ… ä¼˜åŒ– BusinessException

**æ–‡ä»¶ä¿®æ”¹**ï¼š
```
src/main/java/com/smartats/common/exception/BusinessException.java
```

**æ–°å¢æ„é€ å‡½æ•°**ï¼š
```java
/**
 * æ„é€ å‡½æ•° 2ï¼šä½¿ç”¨é”™è¯¯ç æšä¸¾ + è‡ªå®šä¹‰æ¶ˆæ¯
 * <p>
 * ç”¨æ³•ï¼šthrow new BusinessException(ResultCode.INVALID_CREDENTIALS, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯")
 * <p>
 * åœºæ™¯ï¼šä½¿ç”¨ ResultCode çš„é”™è¯¯ç ï¼Œä½†éœ€è¦è‡ªå®šä¹‰è¿”å›æ¶ˆæ¯ï¼ˆå¦‚ç»Ÿä¸€é”™è¯¯æç¤ºï¼‰
 */
public BusinessException(ResultCode resultCode, String customMessage) {
    super(customMessage);
    this.code = resultCode.getCode();
    this.message = customMessage;
}
```

**æ–°å¢é™æ€å·¥å‚æ–¹æ³•**ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰ï¼š
```java
/**
 * ä½¿ç”¨ ResultCode åˆ›å»ºå¼‚å¸¸ï¼ˆä½¿ç”¨é»˜è®¤æ¶ˆæ¯ï¼‰
 */
public static BusinessException of(ResultCode resultCode) {
    return new BusinessException(resultCode);
}

/**
 * ä½¿ç”¨ ResultCode + è‡ªå®šä¹‰æ¶ˆæ¯åˆ›å»ºå¼‚å¸¸
 */
public static BusinessException of(ResultCode resultCode, String customMessage) {
    return new BusinessException(resultCode, customMessage);
}
```

**ä½¿ç”¨æ–¹å¼å¯¹æ¯”**ï¼š
```java
// æ–¹å¼ 1ï¼šæ„é€ å‡½æ•°ï¼ˆä¼ ç»Ÿï¼‰
throw new BusinessException(ResultCode.INVALID_CREDENTIALS, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");

// æ–¹å¼ 2ï¼šé™æ€å·¥å‚æ–¹æ³•ï¼ˆæ›´ä¼˜é›…ï¼‰
throw BusinessException.of(ResultCode.INVALID_CREDENTIALS, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
```

---

### 5. âœ… ä»£ç è§„èŒƒä¼˜åŒ–

**ä¿®æ­£å†…å®¹**ï¼š
- âŒ "ç™»é™†" â†’ âœ… "ç™»å½•"ï¼ˆæ ‡å‡†æœ¯è¯­ï¼‰
- âŒ æœªä½¿ç”¨çš„å¯¼å…¥åˆ é™¤
- âŒ é”™è¯¯ç ä½¿ç”¨é”™è¯¯ä¿®æ­£

**æ—¥å¿—è§„èŒƒ**ï¼š
```java
// INFOï¼šé‡è¦çš„ä¸šåŠ¡æµç¨‹èŠ‚ç‚¹
log.info("ç”¨æˆ·ç™»å½•è¯·æ±‚ï¼šusername={}", username);
log.info("ç™»å½•æˆåŠŸï¼šuserId={}, username={}", userId, username);

// WARNï¼šæ½œåœ¨é—®é¢˜ï¼Œéœ€è¦å…³æ³¨
log.warn("ç™»å½•å¤±è´¥ï¼šç”¨æˆ·ä¸å­˜åœ¨ - {}", username);
log.warn("ç™»å½•å¤±è´¥ï¼šå¯†ç é”™è¯¯ - username={}", username);

// ERRORï¼šç³»ç»Ÿçº§é”™è¯¯ï¼Œéœ€è¦ç«‹å³å¤„ç†
log.error("æ³¨å†Œå¤±è´¥ï¼šæ•°æ®åº“æ’å…¥å¤±è´¥ - username={}", username);

// DEBUGï¼šè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼ˆç”Ÿäº§ç¯å¢ƒå…³é—­ï¼‰
log.debug("å¯†ç å·²åŠ å¯†ï¼šåŸå§‹å¯†ç ={}ï¼ŒåŠ å¯†å={}", raw, encoded);
```

---

## âš ï¸ é‡è¦å‘ç°ï¼šå¼€å‘é¡ºåºé—®é¢˜

### é—®é¢˜ï¼šSpring Security æ‹¦æˆªæ‰€æœ‰è¯·æ±‚

**ç°è±¡**ï¼š
- æ‰€æœ‰æ¥å£è¯·æ±‚éƒ½è¿”å› 401 Unauthorized
- æ— æ³•æµ‹è¯•æ³¨å†Œ/ç™»å½•åŠŸèƒ½

**åŸå› **ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æˆ‘ä»¬çš„é”™è¯¯å¼€å‘é¡ºåº                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  1. âœ… å†™ UserServiceï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰                        â”‚
â”‚  2. âœ… å†™ AuthControllerï¼ˆæ¥å£ï¼‰                         â”‚
â”‚  3. âŒ æµ‹è¯•æ¥å£ â†’ 401ï¼ˆè¢« Spring Security æ‹¦æˆªï¼‰         â”‚
â”‚  4. â“ å‘ç°éœ€è¦é…ç½® Security                             â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ­£ç¡®çš„å¼€å‘é¡ºåºåº”è¯¥æ˜¯**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­£ç¡®çš„å¼€å‘é¡ºåº âœ…                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  1. âœ… é…ç½® Spring Securityï¼ˆå…è®¸æ³¨å†Œ/ç™»å½•åŒ¿åè®¿é—®ï¼‰     â”‚
â”‚  2. âœ… å†™ UserServiceï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰                        â”‚
â”‚  3. âœ… å†™ AuthControllerï¼ˆæ¥å£ï¼‰                         â”‚
â”‚  4. âœ… æµ‹è¯•æ¥å£ â†’ æˆåŠŸ                                  â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç»éªŒæ•™è®­**ï¼š
> **å…ˆæ‰“å¼€"é—¨"ï¼Œå†è¿›"å±‹"**
>
> å¯¹äºéœ€è¦è®¤è¯çš„ç³»ç»Ÿï¼Œå¼€å‘é¡ºåºåº”è¯¥æ˜¯ï¼š
> 1. å…ˆé…ç½® Securityï¼ˆå®šä¹‰å“ªäº›æ¥å£éœ€è¦è®¤è¯ï¼Œå“ªäº›ä¸éœ€è¦ï¼‰
> 2. å†å†™ä¸šåŠ¡é€»è¾‘ï¼ˆå†™å®Œå°±èƒ½æµ‹è¯•ï¼‰
> 3. æœ€åå®Œå–„è®¤è¯é€»è¾‘ï¼ˆJWT è¿‡æ»¤å™¨ç­‰ï¼‰

---

## ğŸ”§ å¾…å®Œæˆä»»åŠ¡ï¼ˆä¸‹æ¬¡ä¼šè¯ï¼‰

### é«˜ä¼˜å…ˆçº§

1. **é…ç½® Spring Security** â­ æœ€é‡è¦
   - åˆ›å»º `SecurityConfig.java`
   - å…è®¸ `/api/v1/auth/register` å’Œ `/api/v1/auth/login` åŒ¿åè®¿é—®
   - å…¶ä»–æ¥å£éœ€è¦ Tokenï¼ˆåç»­å®ç° JWT è¿‡æ»¤å™¨ï¼‰

2. **åˆ›å»ºæ•°æ®åº“å’Œè¡¨**
   - æ‰§è¡Œ `init.sql` è„šæœ¬
   - éªŒè¯è¡¨ç»“æ„

3. **æµ‹è¯•è®¤è¯æ¥å£**
   - æ³¨å†Œæ–°ç”¨æˆ·
   - ç™»å½•è·å– Token
   - éªŒè¯å„ç§é”™è¯¯åœºæ™¯

### ä¸­ä¼˜å…ˆçº§

4. **å®ç° JWT è®¤è¯è¿‡æ»¤å™¨**
   - ä»è¯·æ±‚å¤´æå– Token
   - éªŒè¯ Token æœ‰æ•ˆæ€§
   - åŠ è½½ç”¨æˆ·ä¿¡æ¯åˆ° SecurityContext

5. **å®ç° UserDetailsService**
   - æ ¹æ® userId æˆ– username åŠ è½½ç”¨æˆ·è¯¦æƒ…
   - ä¾› Spring Security ä½¿ç”¨

6. **å®ç° Token åˆ·æ–°æ¥å£**
   - POST /api/v1/auth/refresh
   - éªŒè¯ refreshToken
   - è¿”å›æ–°çš„ accessToken

---

## ğŸ“Š æŠ€æœ¯çŸ¥è¯†ç‚¹æ€»ç»“

### 1. MyBatis-Plus LambdaQueryWrapper

**ä¸ºä»€ä¹ˆä½¿ç”¨ Lambda è¡¨è¾¾å¼ï¼Ÿ**

```java
// âŒ å­—ç¬¦ä¸²æ–¹å¼ï¼ˆä¸æ¨èï¼‰
userMapper.selectOne(
    new QueryWrapper<User>()
        .eq("username", username)  // ç¡¬ç¼–ç å­—æ®µå
);

// âœ… Lambda æ–¹å¼ï¼ˆæ¨èï¼‰
userMapper.selectOne(
    new LambdaQueryWrapper<User>()
        .eq(User::getUsername, username)  // æ–¹æ³•å¼•ç”¨ï¼Œç±»å‹å®‰å…¨
);
```

**ä¼˜åŠ¿**ï¼š
- âœ… ç±»å‹å®‰å…¨ï¼ˆç¼–è¯‘æœŸæ£€æŸ¥ï¼‰
- âœ… é‡æ„å‹å¥½ï¼ˆIDE è‡ªåŠ¨é‡æ„ï¼‰
- âœ… å¯è¯»æ€§å¥½ï¼ˆIDE è‡ªåŠ¨è¡¥å…¨ï¼‰

---

### 2. BCrypt å¯†ç åŠ å¯†

**ä¸ºä»€ä¹ˆä½¿ç”¨ BCryptï¼Ÿ**

```
åŸå§‹å¯†ç ï¼š123456

BCrypt åŠ å¯†åï¼š
$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi
â””â”€â”¬â”€â”˜â””â”€â”¬â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 ç®—æ³•  æˆæœ¬  å®é™… hashï¼ˆåŒ…å«éšæœº saltï¼‰
```

**ç‰¹æ€§**ï¼š
- æ¯æ¬¡åŠ å¯†ç»“æœä¸åŒï¼ˆéšæœº saltï¼‰
- æ— æ³•åå‘è§£å¯†ï¼ˆå•å‘å“ˆå¸Œï¼‰
- è®¡ç®—æ…¢ï¼ˆé˜²æ­¢æš´åŠ›ç ´è§£ï¼‰

**ä½¿ç”¨æ–¹å¼**ï¼š
```java
// åŠ å¯†
String encodedPassword = passwordEncoder.encode("123456");

// éªŒè¯
boolean matches = passwordEncoder.matches("123456", encodedPassword);
```

---

### 3. ç»Ÿä¸€é”™è¯¯æç¤ºï¼ˆå®‰å…¨è®¾è®¡ï¼‰

**ä¸ºä»€ä¹ˆç”¨æˆ·åä¸å­˜åœ¨å’Œå¯†ç é”™è¯¯è¿”å›ç›¸åŒæç¤ºï¼Ÿ**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âŒ ä¸å®‰å…¨çš„è®¾è®¡                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  é»‘å®¢å°è¯•ç”¨æˆ·å "admin"                                  â”‚
â”‚  â†’ è¿”å›ï¼š"å¯†ç é”™è¯¯"                                      â”‚
â”‚  â†’ âœ… ç¡®è®¤ç”¨æˆ·åå­˜åœ¨                                     â”‚
â”‚                                                         â”‚
â”‚  é»‘å®¢å°è¯•ç”¨æˆ·å "administrator"                          â”‚
â”‚  â†’ è¿”å›ï¼š"ç”¨æˆ·ä¸å­˜åœ¨"                                    â”‚
â”‚  â†’ âŒ è¯¥ç”¨æˆ·åä¸å­˜åœ¨                                     â”‚
â”‚                                                         â”‚
â”‚  â†’ é»‘å®¢é€šè¿‡æšä¸¾ç”¨æˆ·åï¼Œè·å–ç³»ç»Ÿæ‰€æœ‰æœ‰æ•ˆç”¨æˆ·ï¼            â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… å®‰å…¨çš„è®¾è®¡                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  é»‘å®¢å°è¯•ç”¨æˆ·å "admin"                                  â”‚
â”‚  â†’ è¿”å›ï¼š"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"                              â”‚
â”‚  â†’ â“ ä¸çŸ¥é“å…·ä½“å“ªä¸ªé”™äº†                                 â”‚
â”‚                                                         â”‚
â”‚  é»‘å®¢å°è¯•ç”¨æˆ·å "administrator"                          â”‚
â”‚  â†’ è¿”å›ï¼š"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"                              â”‚
â”‚  â†’ â“ åŒæ ·ä¸çŸ¥é“å…·ä½“å“ªä¸ªé”™äº†                             â”‚
â”‚                                                         â”‚
â”‚  â†’ é»‘å®¢æ— æ³•åˆ¤æ–­ç”¨æˆ·åæ˜¯å¦å­˜åœ¨ï¼                          â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°ä»£ç **ï¼š
```java
if (user == null) {
    throw new BusinessException(ResultCode.INVALID_CREDENTIALS, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
}

if (!passwordEncoder.matches(request.getPassword(), user.getPassword())) {
    throw new BusinessException(ResultCode.INVALID_CREDENTIALS, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
}
```

---

### 4. @Transactional æ³¨è§£

**ä¸ºä»€ä¹ˆæ³¨å†Œæ–¹æ³•è¦åŠ äº‹åŠ¡ï¼Ÿ**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸ä½¿ç”¨äº‹åŠ¡çš„åœºæ™¯                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  æ³¨å†Œæµç¨‹ï¼š                                              â”‚
â”‚  1. æ£€æŸ¥ç”¨æˆ·å âœ…                                        â”‚
â”‚  2. æ’å…¥ç”¨æˆ·è®°å½• âœ…                                       â”‚
â”‚  3. æ›´æ–°é…é¢è¡¨ âŒï¼ˆå¤±è´¥ï¼‰                                 â”‚
â”‚                                                         â”‚
â”‚  ç»“æœï¼šæ•°æ®ä¸ä¸€è‡´ï¼                                       â”‚
â”‚  - users è¡¨æœ‰è®°å½•                                        â”‚
â”‚  - quota è¡¨ æ²¡è®°å½•                                       â”‚
â”‚  â†’ åç»­æŸ¥è¯¢ä¼šå‡ºé”™                                        â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä½¿ç”¨ @Transactional çš„åœºæ™¯                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  æ³¨å†Œæµç¨‹ï¼š                                              â”‚
â”‚  1. æ£€æŸ¥ç”¨æˆ·å âœ…                                        â”‚
â”‚  2. æ’å…¥ç”¨æˆ·è®°å½• âœ…                                       â”‚
â”‚  3. æ›´æ–°é…é¢è¡¨ âŒï¼ˆå¤±è´¥ï¼‰                                 â”‚
â”‚                                                         â”‚
â”‚  äº‹åŠ¡å›æ»š â†’ æ‰€æœ‰æ“ä½œæ’¤é”€ï¼                                â”‚
â”‚  - users è¡¨ å›æ»š                                          â”‚
â”‚  - quota è¡¨ å›æ»š                                          â”‚
â”‚  â†’ æ•°æ®åº“æ¢å¤åˆ°æ“ä½œå‰çš„çŠ¶æ€                               â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä»£ç **ï¼š
```java
@Transactional(rollbackFor = Exception.class)
public void register(RegisterRequest request) {
    // ä»»ä½•å¼‚å¸¸éƒ½ä¼šå›æ»š
}
```

---

## ğŸ¯ ä»£ç è´¨é‡æå‡ç‚¹

### 1. å‘½åè§„èŒƒ

**æ—¥å¿—æœ¯è¯­ç»Ÿä¸€**ï¼š
- âœ… "ç™»å½•"ï¼ˆæ ‡å‡†ï¼‰
- âŒ "ç™»é™†"ï¼ˆé”™è¯¯ï¼‰

**æ–¹æ³•å‘½å**ï¼š
- âœ… `register()`ï¼ˆæ³¨å†Œï¼‰
- âœ… `login()`ï¼ˆç™»å½•ï¼‰
- âœ… `logout()`ï¼ˆç™»å‡ºï¼‰

### 2. å¼‚å¸¸å¤„ç†è§„èŒƒ

```java
// âœ… æ¨èï¼šä½¿ç”¨ ResultCode æšä¸¾
throw new BusinessException(ResultCode.USERNAME_ALREADY_EXISTS);

// âœ… æ¨èï¼šä½¿ç”¨ ResultCode + è‡ªå®šä¹‰æ¶ˆæ¯
throw new BusinessException(ResultCode.INVALID_CREDENTIALS, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");

// âš ï¸ è°¨æ…ä½¿ç”¨ï¼šå®Œå…¨è‡ªå®šä¹‰
throw new BusinessException(99999, "ä¸´æ—¶é”™è¯¯");
```

### 3. æ—¥å¿—åˆ†çº§

```java
// INFOï¼šé‡è¦çš„ä¸šåŠ¡æµç¨‹èŠ‚ç‚¹
log.info("ç”¨æˆ·ç™»å½•è¯·æ±‚ï¼šusername={}", username);
log.info("ç™»å½•æˆåŠŸï¼šuserId={}, username={}", userId, username);

// WARNï¼šæ½œåœ¨é—®é¢˜ï¼Œéœ€è¦å…³æ³¨
log.warn("ç™»å½•å¤±è´¥ï¼šç”¨æˆ·ä¸å­˜åœ¨ - {}", username);
log.warn("ç™»å½•å¤±è´¥ï¼šå¯†ç é”™è¯¯ - username={}", username);

// ERRORï¼šç³»ç»Ÿçº§é”™è¯¯ï¼Œéœ€è¦ç«‹å³å¤„ç†
log.error("æ³¨å†Œå¤±è´¥ï¼šæ•°æ®åº“æ’å…¥å¤±è´¥ - username={}", username);

// DEBUGï¼šè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼ˆç”Ÿäº§ç¯å¢ƒå…³é—­ï¼‰
log.debug("å¯†ç å·²åŠ å¯†ï¼šåŸå§‹å¯†ç ={}ï¼ŒåŠ å¯†å={}", raw, encoded);
```

---

## ğŸ“ å¼€å‘è§„èŒƒæ€»ç»“

### 1. å¼€å‘é¡ºåºè§„èŒƒ

å¯¹äºéœ€è¦è®¤è¯çš„ç³»ç»Ÿï¼š
1. **å…ˆé…ç½® Security**ï¼ˆå®šä¹‰å“ªäº›æ¥å£éœ€è¦è®¤è¯ï¼‰
2. **å†å†™ä¸šåŠ¡é€»è¾‘**ï¼ˆå†™å®Œå°±èƒ½æµ‹è¯•ï¼‰
3. **æœ€åå®Œå–„è®¤è¯**ï¼ˆJWT è¿‡æ»¤å™¨ç­‰ï¼‰

### 2. ä»£ç å®¡æŸ¥æ£€æŸ¥ç‚¹

- [ ] æ˜¯å¦ä½¿ç”¨ LambdaQueryWrapperï¼ˆç±»å‹å®‰å…¨ï¼‰
- [ ] æ•æ„Ÿä¿¡æ¯æ˜¯å¦åŠ å¯†ï¼ˆå¯†ç ã€Tokenï¼‰
- [ ] é”™è¯¯æç¤ºæ˜¯å¦ç»Ÿä¸€ï¼ˆé˜²æ­¢ä¿¡æ¯æ³„éœ²ï¼‰
- [ ] æ˜¯å¦ä½¿ç”¨äº‹åŠ¡ï¼ˆä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼‰
- [ ] æ—¥å¿—æ˜¯å¦å®Œæ•´ï¼ˆinfo/warn/error åˆ†çº§ï¼‰
- [ ] å¼‚å¸¸å¤„ç†æ˜¯å¦è§„èŒƒï¼ˆBusinessExceptionï¼‰

### 3. æµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆTDDï¼‰

å»ºè®®æµç¨‹ï¼š
1. å…ˆå†™æ¥å£æ–‡æ¡£ï¼ˆå®šä¹‰è¯·æ±‚/å“åº”ï¼‰
2. å†å†™ä¸šåŠ¡é€»è¾‘
3. ç«‹å³æµ‹è¯•ï¼ˆå‘ç°é—®é¢˜ç«‹å³ä¿®å¤ï¼‰

---

## ğŸ“ ç»éªŒæ•™è®­

### æ•™è®­ 1ï¼šå¼€å‘é¡ºåºå¾ˆé‡è¦

> **å…ˆé…ç½®åŸºç¡€è®¾æ–½ï¼Œå†å¼€å‘ä¸šåŠ¡åŠŸèƒ½**
>
> å¯¹äºè®¤è¯ç³»ç»Ÿï¼Œåº”è¯¥å…ˆé…ç½® Securityï¼Œå¦åˆ™æ— æ³•æµ‹è¯•ã€‚

### æ•™è®­ 2ï¼šç±»å‹å®‰å…¨ä¼˜å…ˆ

> **èƒ½ç”¨ç¼–è¯‘æœŸæ£€æŸ¥ï¼Œå°±ä¸è¦ä¾èµ–è¿è¡ŒæœŸ**
>
> LambdaQueryWrapper æ¯”å­—ç¬¦ä¸²æ–¹å¼æ›´å®‰å…¨ã€‚

### æ•™è®­ 3ï¼šå®‰å…¨è€ƒè™‘è¦å‰ç½®

> **ä¸è¦ç­‰åˆ°ä¸Šçº¿æ‰è€ƒè™‘å®‰å…¨é—®é¢˜**
>
> ç»Ÿä¸€é”™è¯¯æç¤ºã€å¯†ç åŠ å¯†ç­‰åº”è¯¥åœ¨å¼€å‘åˆæœŸå°±è®¾è®¡å¥½ã€‚

### æ•™è®­ 4ï¼šæ—¥å¿—åˆ†çº§å¾ˆé‡è¦

> **åˆé€‚çš„æ—¥å¿—çº§åˆ«èƒ½å¿«é€Ÿå®šä½é—®é¢˜**
>
- INFOï¼šä¸šåŠ¡æµç¨‹
- WARNï¼šæ½œåœ¨é—®é¢˜
- ERRORï¼šç³»ç»Ÿé”™è¯¯
- DEBUGï¼šè°ƒè¯•ä¿¡æ¯

---

## ğŸ“‚ æœ¬æ¬¡ä¼šè¯ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

### æ–°å»ºæ–‡ä»¶
- `src/main/resources/sql/init.sql` - æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

### ä¿®æ”¹æ–‡ä»¶
- `src/main/java/com/smartats/module/auth/service/UserService.java` - å®ç°çœŸå®æ•°æ®åº“äº¤äº’
- `src/main/java/com/smartats/common/result/ResultCode.java` - æ–°å¢é”™è¯¯ç 
- `src/main/java/com/smartats/common/exception/BusinessException.java` - æ–°å¢æ„é€ å‡½æ•°å’Œé™æ€å·¥å‚æ–¹æ³•

### å¾…åˆ›å»ºæ–‡ä»¶ï¼ˆä¸‹æ¬¡ä¼šè¯ï¼‰
- `src/main/java/com/smartats/config/SecurityConfig.java` - Spring Security é…ç½®

---

## ğŸš€ ä¸‹æ¬¡ä¼šè¯å¼€å§‹å‰å‡†å¤‡

### å¿…é¡»å®Œæˆ
1. é˜…è¯»æœ¬ä¼šè¯æ€»ç»“
2. ç†è§£ Spring Security é…ç½®çš„é‡è¦æ€§
3. å‡†å¤‡æµ‹è¯•å·¥å…·ï¼ˆPostman/Apifox/curlï¼‰

### æ¨èé˜…è¯»
- Spring Security å®˜æ–¹æ–‡æ¡£ï¼ˆåŸºç¡€éƒ¨åˆ†ï¼‰
- JWT è®¤è¯åŸç†
- BCrypt å¯†ç åŠ å¯†åŸç†

---

## ğŸ’¬ å¿«é€Ÿé‡å¯å‘½ä»¤

```bash
# åœæ­¢åº”ç”¨
pkill -9 -f SmartAtsApplication

# é‡æ–°å¯åŠ¨
mvn spring-boot:run

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/smartats.log
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**æœ€åæ›´æ–°**ï¼š2026-02-15
**ç»´æŠ¤è€…**ï¼šClaude Code (claude-4.5-sonnet)
